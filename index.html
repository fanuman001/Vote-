<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Host Control v6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --theme: #d4af37; --glow: rgba(212, 175, 55, 0.3); --red: #ff4d4d; }
        body { font-family: sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #2a2a2a; margin-bottom: 15px; }
        h1 { color: var(--theme); font-size: 1.2rem; border-left: 3px solid var(--theme); padding-left: 10px; margin-top:0; }
        input, button, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 10px; box-sizing: border-box; }
        button { background: var(--theme); color: #000; font-weight: bold; border: none; cursor: pointer; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        /* å‹¾é¸æˆå“¡æ¨£å¼ */
        .member-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .member-item { background: #222; padding: 10px; border-radius: 8px; font-size: 14px; display: flex; align-items: center; }
        .member-item input { width: auto; margin-right: 10px; margin-bottom: 0; }

        .option-box { position: relative; background: #222; border-radius: 10px; padding: 15px; margin-bottom: 10px; overflow: hidden; }
        .progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: var(--glow); width: 0%; transition: width 0.2s; }
        .content { position: relative; z-index: 2; display: flex; justify-content: space-between; }
        #sync-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #countdown-num { font-size: 8rem; font-weight: 900; color: var(--theme); }
        .user-chip { display: inline-block; padding: 5px 10px; border-radius: 20px; background: #222; font-size: 11px; margin: 2px; border: 1px solid #333; }
        .user-chip.ready { border-color: var(--theme); color: var(--theme); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="create-view" class="card hidden">
    <h1>ğŸ‘‘ ä¸»æŒäººé¢æ¿</h1>
    <input type="text" id="new-title" placeholder="è³½äº‹é …ç›®åç¨± (å¦‚: ä»Šæ™šå®µå¤œ)">
    
    <label style="font-size: 12px; color: #888;">é¸æ“‡åƒè³½æˆå“¡ï¼š</label>
    <div id="member-checkboxes" class="member-grid"></div>

    <div id="options-input">
        <input type="text" class="opt-in" placeholder="é¸é … 1">
        <input type="text" class="opt-in" placeholder="é¸é … 2">
    </div>

    <select id="mode-select">
        <option value="1">ç«¶æŠ€é€£é» (å€’æ•¸åŒæ­¥)</option>
        <option value="0">ä¸€èˆ¬æŠ•ç¥¨ (ä¸€äººä¸€ç¥¨)</option>
    </select>
    
    <select id="duration-select">
        <option value="15">15 ç§’</option>
        <option value="30" selected>30 ç§’</option>
        <option value="60">60 ç§’</option>
    </select>
    <button onclick="submitNewPoll()">é–‹å•Ÿè³½äº‹æˆ¿</button>
</div>

<div id="login-view" class="card hidden">
    <h1>ğŸ‘¤ èª°åœ¨ç¾å ´ï¼Ÿ</h1>
    <p style="font-size:12px; color:#888;">æ­¤å ´è³½äº‹ç”±ä¸»æŒäººç™¼èµ·ï¼Œè«‹é¸æ“‡æ‚¨çš„èº«åˆ†ï¼š</p>
    <div id="user-select-list"></div>
</div>

<div id="poll-view" class="card hidden">
    <h1 id="poll-display-title"></h1>
    <div id="timer-box" style="text-align:center; font-size:2rem; font-family:monospace; color:var(--red); font-weight:bold; margin-bottom:10px;">ç­‰å¾…æº–å‚™</div>
    <div id="poll-options"></div>
    
    <div id="ready-zone" style="text-align:center; margin-top:20px;">
        <button id="ready-btn" onclick="toggleReady()">æˆ‘æº–å‚™å¥½äº† (READY)</button>
        <div id="ready-list" style="margin-top:10px;"></div>
    </div>

    <div id="admin-controls" class="hidden">
        <button id="start-battle-btn" disabled onclick="broadcastStart()" style="margin-top:20px; background: #fff;">å•Ÿå‹•æ¯”è³½å€’æ•¸</button>
        <button onclick="resetSystem()" style="background:#331111; color:#ff4444; margin-top:20px; font-size:12px;">ğŸ”¥ å¼·åˆ¶çµæŸä¸¦æ¸…ç©ºç³»çµ±</button>
    </div>
</div>

<div id="sync-overlay"><div id="countdown-num">3</div></div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const API_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(API_URL, API_KEY);

    const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
    let currentPoll = null, myName = localStorage.getItem('elite_user'), syncChannel = null, gameEndTime = null;

    async function init() {
        const { data: poll } = await _supabase.from('polls').select('*').order('created_at', {ascending:false}).limit(1).single();
        
        if (isAdmin && !poll) {
            showCreateView();
        } else if (!poll) {
            document.body.innerHTML = `<div class="card" style="text-align:center;"><h1>ğŸ æš«ç„¡è³½äº‹</h1><p>è«‹ç­‰å¾…ä¸»æŒäººé–‹å•Ÿæˆ¿é–“...</p></div>`;
            // ç›£è½æ˜¯å¦æœ‰æ–°æˆ¿é–“é–‹å•Ÿ
            _supabase.channel('lobby').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'polls' }, () => location.reload()).subscribe();
        } else if (!myName) {
            showLoginView(poll);
        } else {
            loadPoll(poll);
        }
    }

    // ä¸»æŒäººï¼šé¡¯ç¤ºæˆå“¡å‹¾é¸ä»‹é¢
    async function showCreateView() {
        document.getElementById('create-view').classList.remove('hidden');
        const { data: players } = await _supabase.from('players').select('name');
        const grid = document.getElementById('member-checkboxes');
        grid.innerHTML = players.map(p => `
            <div class="member-item">
                <input type="checkbox" class="member-chk" value="${p.name}" checked> ${p.name}
            </div>
        `).join('');
    }

    async function submitNewPoll() {
        const title = document.getElementById('new-title').value;
        const selectedMembers = Array.from(document.querySelectorAll('.member-chk:checked')).map(el => el.value);
        const options = {};
        document.querySelectorAll('.opt-in').forEach((el, i) => { if(el.value) options[i+1] = el.value; });

        if (!title || selectedMembers.length === 0) return alert("è«‹è¼¸å…¥æ¨™é¡Œä¸¦è‡³å°‘é¸æ“‡ä¸€äºº");

        await _supabase.from('polls').insert([{ 
            title, options, 
            poll_type: parseInt(document.getElementById('mode-select').value),
            duration_sec: parseInt(document.getElementById('duration-select').value),
            target_voters: selectedMembers.length,
            target_names: selectedMembers // å­˜å…¥é€™å ´æŒ‡å®šçš„æˆå“¡åå–®
        }]);
        location.reload();
    }

    // æˆå“¡ï¼šå¾ä¸»æŒäººæŒ‡å®šåå–®é¸èº«åˆ†
    function showLoginView(poll) {
        document.getElementById('login-view').classList.remove('hidden');
        const list = document.getElementById('user-select-list');
        list.innerHTML = poll.target_names.map(name => 
            `<button onclick="setMe('${name}')" style="background:#222; margin-bottom:5px;">æˆ‘æ˜¯ ${name}</button>`
        ).join('');
    }

    function setMe(name) {
        localStorage.setItem('elite_user', name);
        location.reload();
    }

    async function loadPoll(poll) {
        currentPoll = poll;
        document.getElementById('poll-view').classList.remove('hidden');
        document.getElementById('poll-display-title').innerText = poll.title;
        if (isAdmin) document.getElementById('admin-controls').classList.remove('hidden');

        syncChannel = _supabase.channel('sync_' + poll.id, { config: { presence: { key: myName } } });
        syncChannel.on('presence', { event: 'sync' }, () => updateReadyList())
                   .on('broadcast', { event: 'start_all' }, (p) => { gameEndTime = new Date(p.payload.endTime); runSyncCountdown(); })
                   .subscribe(async (s) => { if(s === 'SUBSCRIBED') await syncChannel.track({ ready: false }); });

        _supabase.channel('db').on('postgres_changes', { event: '*', schema: 'public', table: 'polls' }, (p) => {
            if (p.eventType === 'DELETE') { 
                localStorage.removeItem('elite_user'); 
                location.href = location.pathname + (isAdmin ? '?admin=true' : ''); 
            }
        }).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, () => updateUI()).subscribe();

        if (poll.start_at) { gameEndTime = new Date(poll.end_at); document.getElementById('ready-zone').classList.add('hidden'); startVisualTimer(); }
        updateUI();
    }

    function updateReadyList() {
        const state = syncChannel.presenceState();
        const readyNames = [];
        Object.keys(state).forEach(k => { if(state[k][0].ready) readyNames.push(k); });
        
        document.getElementById('ready-list').innerHTML = currentPoll.target_names.map(n => 
            `<span class="user-chip ${readyNames.includes(n)?'ready':''}">${n}</span>`
        ).join('');

        if (isAdmin) {
            const btn = document.getElementById('start-battle-btn');
            btn.disabled = readyNames.length < currentPoll.target_voters;
        }
    }

    async function toggleReady() {
        const btn = document.getElementById('ready-btn');
        const isNowReady = btn.innerText.includes('READY');
        btn.innerText = isNowReady ? 'å–æ¶ˆæº–å‚™' : 'æˆ‘æº–å‚™å¥½äº† (READY)';
        btn.style.background = isNowReady ? '#444' : 'var(--theme)';
        await syncChannel.track({ ready: isNowReady });
    }

    async function broadcastStart() {
        const endAt = new Date(Date.now() + currentPoll.duration_sec * 1000);
        await _supabase.from('polls').update({ start_at: new Date().toISOString(), end_at: endAt.toISOString() }).eq('id', currentPoll.id);
        syncChannel.send({ type: 'broadcast', event: 'start_all', payload: { endTime: endAt.toISOString() } });
    }

    function runSyncCountdown() {
        document.getElementById('ready-zone').classList.add('hidden');
        document.getElementById('admin-controls').classList.add('hidden');
        const overlay = document.getElementById('sync-overlay'), num = document.getElementById('countdown-num');
        overlay.style.display = 'flex';
        let c = 3;
        const t = setInterval(() => {
            c--; num.innerText = c || 'GO!';
            if (c < 0) { clearInterval(t); overlay.style.display = 'none'; startVisualTimer(); }
        }, 1000);
    }

    function startVisualTimer() {
        const tBox = document.getElementById('timer-box');
        if (currentPoll.poll_type == 0) { tBox.innerText = "ä¸€äººä¸€ç¥¨æ¨¡å¼"; return; }
        const iv = setInterval(() => {
            const diff = (gameEndTime - Date.now()) / 1000;
            if (diff <= 0) { clearInterval(iv); tBox.innerText = "FINISH"; confetti(); }
            else { tBox.innerText = diff.toFixed(1) + "s"; }
        }, 50);
    }

    async function castVote(optId) {
        if (currentPoll.poll_type == 1) { if (!gameEndTime || Date.now() > gameEndTime) return; }
        else { 
            const { data } = await _supabase.from('votes').select('id').eq('poll_id', currentPoll.id).eq('voter_name', myName);
            if (data.length > 0) return alert("å·²æŠ•éç¥¨");
        }
        await _supabase.from('votes').insert([{ poll_id: currentPoll.id, option_id: optId, voter_name: myName }]);
    }

    async function updateUI() {
        const { data: vData } = await _supabase.from('votes').select('option_id, voter_name').eq('poll_id', currentPoll.id);
        const stats = {};
        vData.forEach(v => stats[v.option_id] = (stats[v.option_id] || 0) + 1);
        const container = document.getElementById('poll-options');
        container.innerHTML = '';
        Object.entries(currentPoll.options).forEach(([id, text]) => {
            const count = stats[id] || 0;
            const max = Math.max(...Object.values(stats), 1);
            const percent = currentPoll.poll_type == 1 ? (count/max)*100 : (count/currentPoll.target_voters)*100;
            container.innerHTML += `<div class="option-box" onclick="castVote('${id}')"><div class="progress-fill" style="width:${percent}%"></div><div class="content"><span>${text}</span><span>${count}</span></div></div>`;
        });
    }

    async function resetSystem() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™æœƒæ¸…ç©ºæ‰€æœ‰èº«åˆ†ç·©å­˜ï¼")) {
            await _supabase.from('polls').delete().eq('id', currentPoll.id);
        }
    }

    init();
</script>
</body>
</html>

