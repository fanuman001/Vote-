<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Poll Pro - Auto Reset</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --theme: #d4af37; --glow: rgba(212, 175, 55, 0.3); --gray: #888; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); color: #e0e0e0; padding: 15px; margin: 0; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid #2a2a2a; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        h1 { color: var(--theme); font-size: 18px; margin: 0 0 20px 0; border-left: 3px solid var(--theme); padding-left: 12px; }
        input, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 10px; box-sizing: border-box; }
        button { background: var(--theme); color: #000; font-weight: bold; border: none; cursor: pointer; }
        .option-box { position: relative; background: #222; border: 1px solid #333; border-radius: 12px; padding: 18px; margin-bottom: 12px; cursor: pointer; overflow: hidden; }
        .progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: var(--glow); width: 0%; z-index: 1; transition: width 0.8s ease; }
        .option-content { position: relative; z-index: 2; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        .danger-zone { margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }
        .btn-delete { background: #441111; color: #ff4444; border: 1px solid #662222; font-size: 12px; }
    </style>
</head>
<body>

<div id="create-view" class="card">
    <h1>ğŸ†• ç™¼èµ·æ–°æŠ•ç¥¨</h1>
    <input type="text" id="new-title" placeholder="é¡Œç›® (ä¾‹å¦‚: ä¸‹ä¸€å ´æ‰“ä»€éº¼?)" oninput="detectTheme(this.value)">
    <div id="options-input">
        <input type="text" class="opt-in" placeholder="é¸é … 1">
        <input type="text" class="opt-in" placeholder="é¸é … 2">
    </div>
    <button onclick="addOptionField()" style="background:#222; color:#fff;">ï¼‹ å¢åŠ é¸é …</button>
    <button onclick="submitNewPoll()" style="margin-top:10px;">æ­£å¼ç™¼ä½ˆ</button>
</div>

<div id="poll-view" class="card hidden">
    <h1 id="poll-display-title">è¼‰å…¥ä¸­...</h1>
    <div id="poll-options"></div>
    
    <div class="danger-zone">
        <button class="btn-delete" onclick="resetSystem()">ğŸ”¥ çµæŸä¸¦æ¸…ç©ºæ­¤æŠ•ç¥¨ç´€éŒ„</button>
    </div>
</div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const API_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(API_URL, API_KEY);

    let currentPoll = null;

    // åµæ¸¬ä¸»é¡Œé¡è‰²
    function detectTheme(text) {
        const themes = {
            'game': { keywords: ['æ‰“', 'ç©', 'lol', 'game'], color: '#00f2fe', glow: 'rgba(0, 242, 254, 0.3)' },
            'food': { keywords: ['åƒ', 'é£¯', 'é¤“'], color: '#ff7e5f', glow: 'rgba(255, 126, 95, 0.3)' }
        };
        let theme = { color: '#d4af37', glow: 'rgba(212, 175, 55, 0.3)' };
        for (let k in themes) {
            if (themes[k].keywords.some(kw => text.includes(kw))) theme = themes[k];
        }
        document.documentElement.style.setProperty('--theme', theme.color);
        document.documentElement.style.setProperty('--glow', theme.glow);
    }

    function addOptionField() {
        const input = document.createElement('input');
        input.type = 'text'; input.className = 'opt-in';
        input.placeholder = `é¸é … ${document.querySelectorAll('.opt-in').length + 1}`;
        document.getElementById('options-input').appendChild(input);
    }

    async function submitNewPoll() {
        const title = document.getElementById('new-title').value;
        const options = {};
        document.querySelectorAll('.opt-in').forEach((el, i) => { if(el.value) options[i+1] = el.value; });

        if (!title || Object.keys(options).length < 2) return alert("è«‹å®Œæ•´å¡«å¯«");

        const { data } = await _supabase.from('polls').insert([{ title, options }]).select().single();
        if (data) loadPoll(data.id);
    }

    async function loadPoll(id) {
        document.getElementById('create-view').classList.add('hidden');
        document.getElementById('poll-view').classList.remove('hidden');

        const { data: poll } = await _supabase.from('polls').select('*').eq('id', id).single();
        currentPoll = poll;
        document.getElementById('poll-display-title').innerText = poll.title;
        detectTheme(poll.title);
        updateVotes();

        // ç›£è½å³æ™‚æ›´æ–°èˆ‡ã€Œè¢«åˆªé™¤ã€äº‹ä»¶
        _supabase.channel('poll_channel').on('postgres_changes', 
            { event: '*', schema: 'public', table: 'polls' }, (payload) => {
                if (payload.eventType === 'DELETE') location.reload(); // å¦‚æœé¡Œç›®è¢«åˆªé™¤ï¼Œå¤§å®¶åŒæ­¥é‡æ•´
            }
        ).on('postgres_changes', 
            { event: 'INSERT', schema: 'public', table: 'votes' }, () => updateVotes()
        ).subscribe();
    }

    async function castVote(optId) {
        if (localStorage.getItem('voted_' + currentPoll.id)) return;
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
        await _supabase.from('votes').insert([{ poll_id: currentPoll.id, option_id: optId }]);
        localStorage.setItem('voted_' + currentPoll.id, optId);
        updateVotes();
    }

    async function updateVotes() {
        const { data: votes } = await _supabase.from('votes').select('option_id').eq('poll_id', currentPoll.id);
        const total = votes.length;
        const stats = {};
        votes.forEach(v => stats[v.option_id] = (stats[v.option_id] || 0) + 1);

        const container = document.getElementById('poll-options');
        container.innerHTML = '';
        const hasVoted = localStorage.getItem('voted_' + currentPoll.id);

        Object.entries(currentPoll.options).forEach(([id, text]) => {
            const percent = total === 0 ? 0 : Math.round(((stats[id] || 0) / total) * 100);
            container.innerHTML += `
                <div class="option-box" onclick="${hasVoted ? '' : `castVote('${id}')`}">
                    <div class="progress-fill" style="width: ${percent}%"></div>
                    <div class="option-content">
                        <span>${text}</span>
                        <span>${percent}%</span>
                    </div>
                </div>`;
        });
    }

    // ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸…ç©ºé‡é–‹
    async function resetSystem() {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å ´æŠ•ç¥¨çš„æ‰€æœ‰ç´€éŒ„ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ")) return;

        // 1. åˆªé™¤ç•¶å‰æŠ•ç¥¨é¡Œç›® (å› ç‚ºè¨­äº† CASCADEï¼Œå°æ‡‰çš„é¸ç¥¨æœƒè‡ªå‹•è¢«åˆªé™¤)
        const { error } = await _supabase.from('polls').delete().eq('id', currentPoll.id);

        if (!error) {
            alert("ç³»çµ±å·²é‡ç½®");
            location.reload(); // å›åˆ°å»ºç«‹ä»‹é¢
        } else {
            alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLS æ¬Šé™");
        }
    }

    // åˆå§‹æª¢æŸ¥ï¼šå¦‚æœæœ‰èˆŠæŠ•ç¥¨é‚„åœ¨ï¼Œç›´æ¥è¼‰å…¥
    async function checkActivePoll() {
        const { data } = await _supabase.from('polls').select('*').order('created_at', {ascending: false}).limit(1).single();
        if (data) loadPoll(data.id);
    }
    checkActivePoll();
</script>

</body>
</html>

