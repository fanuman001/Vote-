<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Poll Master v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --gold: #d4af37; --gray: #888; --blue: #3498db; --green: #2ecc71; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); color: #e0e0e0; padding: 15px; margin: 0; }
        
        /* 繼承 Ledger Pro 風格 */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sys-status { font-size: 10px; color: var(--gold); letter-spacing: 1px; }
        
        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid #2a2a2a; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        h1 { color: var(--gold); font-size: 18px; margin: 0 0 25px 0; border-left: 3px solid var(--gold); padding-left: 12px; }
        
        /* 遊戲化投票選項 */
        .option-box { 
            position: relative; 
            background: #222; 
            border: 1px solid #333; 
            border-radius: 12px; 
            padding: 18px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            overflow: hidden; 
            transition: 0.3s;
        }
        .option-box:hover { border-color: var(--gold); transform: translateY(-2px); }
        .option-box:active { transform: scale(0.98); }

        .progress-fill {
            position: absolute;
            left: 0; top: 0; bottom: 0;
            background: rgba(212, 175, 55, 0.15);
            width: 0%;
            z-index: 1;
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 500;
        }

        .vote-percent { color: var(--gold); font-family: monospace; font-size: 16px; }

        .footer { text-align: center; font-size: 10px; color: var(--gray); margin-top: 30px; }
        .hash-code { font-family: monospace; color: var(--blue); margin-top: 5px; opacity: 0.6; }

        /* 載入中動畫 */
        .loader { text-align: center; color: var(--gold); padding: 20px; }
    </style>
</head>
<body>

<div class="top-nav">
    <div class="sys-status">● ELITE VOTE SECURE-LINK</div>
    <div style="font-size: 10px; color: var(--gray);">ID: nzuxyief...</div>
</div>

<div class="card">
    <h1 id="poll-title">正在連線至加密伺服器...</h1>
    <div id="poll-options">
        <div class="loader">讀取中...</div>
    </div>
</div>

<div class="footer">
    DECENTRALIZED VERIFICATION HASH
    <div id="verify-hash" class="hash-code">WAITING FOR DATA...</div>
</div>

<script>
    // 結合你的專屬鑰匙
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const API_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(API_URL, API_KEY);

    let currentPoll = null;

    async function init() {
        // 1. 抓取最新的一個投票題目
        const { data: poll, error } = await _supabase.from('polls').select('*').order('created_at', { ascending: false }).limit(1).single();
        
        if (error || !poll) {
            document.getElementById('poll-title').innerText = "暫無投票活動";
            document.getElementById('poll-options').innerHTML = "";
            return;
        }

        currentPoll = poll;
        document.getElementById('poll-title').innerText = poll.title;
        
        // 2. 初始渲染
        renderOptions(poll.options);
        updateVotes();

        // 3. 開啟 Realtime 即時聽取新選票
        _supabase.channel('any')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, () => {
                updateVotes();
            })
            .subscribe();
    }

    function renderOptions(options) {
        const container = document.getElementById('poll-options');
        container.innerHTML = '';
        Object.entries(options).forEach(([id, text]) => {
            container.innerHTML += `
                <div class="option-box" onclick="castVote('${id}')">
                    <div class="progress-fill" id="fill-${id}"></div>
                    <div class="option-content">
                        <span>${text}</span>
                        <span class="vote-percent" id="perc-${id}">0%</span>
                    </div>
                </div>
            `;
        });
    }

    async function castVote(optId) {
        // 遊戲化特效：噴發金幣色紙屑
        confetti({
            particleCount: 100,
            spread: 60,
            colors: ['#d4af37', '#ffffff', '#f9f6ef'],
            origin: { y: 0.8 }
        });

        const { error } = await _supabase.from('votes').insert([
            { poll_id: currentPoll.id, option_id: optId }
        ]);

        if (error) console.error("Vote Error:", error);
    }

    async function updateVotes() {
        const { data: votes } = await _supabase.from('votes').select('option_id').eq('poll_id', currentPoll.id);
        
        const total = votes.length;
        const stats = {};
        votes.forEach(v => stats[v.option_id] = (stats[v.option_id] || 0) + 1);

        // 更新進度條與百分比
        Object.keys(currentPoll.options).forEach(optId => {
            const count = stats[optId] || 0;
            const percent = total === 0 ? 0 : Math.round((count / total) * 100);
            
            const fill = document.getElementById(`fill-${optId}`);
            const text = document.getElementById(`perc-${optId}`);
            
            if (fill) fill.style.width = percent + '%';
            if (text) text.innerText = percent + '%';
        });

        // 產生透明指紋 (SHA-256 簡化版模擬)
        const fingerprint = btoa(JSON.stringify(votes)).substring(0, 16).toUpperCase();
        document.getElementById('verify-hash').innerText = `VERIFY_SIG: ${fingerprint}-${total}VOTES`;
    }

    init();
</script>

</body>
</html>
