<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Sync Master v13.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --theme: #d4af37; --glow: rgba(212, 175, 55, 0.4); --red: #ff4d4d; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 15px; user-select: none; -webkit-tap-highlight-color: transparent; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #2a2a2a; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: var(--theme); font-size: 1.2rem; border-left: 3px solid var(--theme); padding-left: 10px; margin: 0 0 15px 0; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--theme); color: #000; font-weight: 800; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.96); }
        button:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 10px; box-sizing: border-box; }
        .member-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .member-item { background: #222; padding: 10px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; border: 1px solid #333; }
        .member-item input { width: auto; margin-right: 10px; margin-bottom: 0; }
        
        /* æŠ•ç¥¨é¸é …æ¨£å¼ */
        .option-box { position: relative; background: #222; border-radius: 12px; padding: 20px; margin-bottom: 12px; overflow: hidden; border: 2px solid #333; cursor: pointer; transition: 0.2s; touch-action: manipulation; }
        .option-box.voted { border-color: var(--theme); box-shadow: 0 0 15px var(--glow); background: #2a2a2a; }
        .progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: var(--glow); width: 0%; transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); z-index: 1; pointer-events: none; }
        .content { position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; font-weight: 900; pointer-events: none; }
        .voted-mark { font-size: 10px; color: var(--theme); margin-top: 4px; display: none; }
        .option-box.voted .voted-mark { display: block; }
        
        .user-chip { display: inline-block; padding: 5px 12px; border-radius: 20px; background: #111; font-size: 11px; margin: 3px; border: 1px solid #333; color: #555; }
        .user-chip.ready { border-color: var(--theme); color: var(--theme); background: rgba(212,175,55,0.15); box-shadow: 0 0 8px var(--glow); }
        #sync-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #countdown-num { font-size: 9rem; color: var(--theme); font-weight: 900; }
        .timer-display { text-align: center; font-size: 2.5rem; color: var(--red); font-weight: 900; margin: 10px 0; font-family: monospace; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="create-view" class="card hidden">
    <h1>ğŸ‘‘ æˆ¿ä¸»è¨­å®šè³½äº‹</h1>
    <input type="text" id="new-title" placeholder="è¼¸å…¥ç«¶è³½é …ç›®åç¨±">
    <div id="member-checkboxes" class="member-grid"></div>
    <div id="options-input">
        <input type="text" class="opt-in" placeholder="é¸é … A">
        <input type="text" class="opt-in" placeholder="é¸é … B">
    </div>
    <select id="mode-select" onchange="document.getElementById('duration-box').style.display = this.value=='1'?'block':'none'">
        <option value="0">ğŸ—³ï¸ æŠ•ç¥¨æ¨¡å¼ (ä¸€äººä¸€ç¥¨)</option>
        <option value="1">ğŸ”¥ ç«¶æŠ€æ¨¡å¼ (ç˜‹ç‹‚é€£é»)</option>
    </select>
    <div id="duration-box" style="display:none"><select id="duration-select"><option value="15">15ç§’</option><option value="30" selected>30ç§’</option></select></div>
    <button onclick="submitNewPoll()">é–‹å•Ÿæˆ¿é–“</button>
</div>

<div id="login-view" class="card hidden">
    <h1>ğŸ‘¤ é¸æ“‡æ‚¨çš„èº«ä»½</h1>
    <div id="user-select-list"></div>
</div>

<div id="poll-view" class="card hidden">
    <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-bottom:10px;">
        <span id="mode-label">---</span><span id="voter-stats">0/0</span>
    </div>
    <h1 id="poll-display-title">---</h1>
    <div id="timer-box" class="timer-display">æº–å‚™ä¸­</div>
    <div id="poll-options"></div>
    
    <div id="ready-zone" style="text-align:center; margin-top:20px;">
        <p id="id-name" style="color:var(--theme); font-size:13px; font-weight:bold;"></p>
        <button id="ready-btn" onclick="toggleReady()">READY é»æˆ‘æº–å‚™</button>
        <div id="ready-list" style="margin-top:15px;"></div>
    </div>

    <div id="admin-controls" class="hidden" style="margin-top:25px; border-top:2px solid #222; padding-top:20px;">
        <button id="start-btn" disabled onclick="broadcastStart()">å•Ÿå‹• (START)</button>
        <button onclick="resetSystem()" style="background:#200; color:#f55; margin-top:10px;">é‡ç½®æˆ¿é–“</button>
    </div>
</div>

<div id="sync-overlay"><div id="countdown-num">3</div></div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
    const API_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const _supabase = supabase.createClient(API_URL, API_KEY);
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
    let currentPoll = null, myName = localStorage.getItem('elite_user'), syncChannel = null;
    let isGameRunning = false, localVotedId = null;

    async function init() {
        const { data: poll } = await _supabase.from('polls').select('*').order('created_at', {ascending:false}).limit(1).maybeSingle();
        if (isAdmin && !poll) return showCreate();
        if (!poll) { document.body.innerHTML = "<div class='card'><h1>ğŸ æˆ¿é–“å°šæœªé–‹å•Ÿ</h1></div>"; return; }
        if (!myName) showLogin(poll); else loadPoll(poll);
    }

    async function showCreate() {
        document.getElementById('create-view').classList.remove('hidden');
        const { data: players } = await _supabase.from('players').select('name');
        // éæ¿¾å‰ç¶´èˆ‡è‡ªå‹•å‹¾é¸
        document.getElementById('member-checkboxes').innerHTML = (players || []).map(p => {
            const isOff = p.name.startsWith('OFF_');
            const cleanName = p.name.replace('OFF_', '');
            return `<div class='member-item'>
                <input type='checkbox' class='m-chk' value='${cleanName}' ${isOff ? '' : 'checked'}> 
                ${cleanName} ${isOff ? '<span style="color:#555">(é›¢ç·š)</span>' : ''}
            </div>`;
        }).join('');
    }

    async function submitNewPoll() {
        const names = Array.from(document.querySelectorAll('.m-chk:checked')).map(e => e.value);
        const opts = {}; document.querySelectorAll('.opt-in').forEach((e, i) => { if(e.value) opts[i+1]=e.value; });
        if(names.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æˆå“¡");
        await _supabase.from('polls').insert([{ 
            title: document.getElementById('new-title').value || "ELITE BATTLE", options: opts,
            poll_type: parseInt(document.getElementById('mode-select').value),
            duration_sec: parseInt(document.getElementById('duration-select').value),
            target_voters: names.length, target_names: names 
        }]);
        location.reload();
    }

    function showLogin(poll) {
        document.getElementById('login-view').classList.remove('hidden');
        document.getElementById('user-select-list').innerHTML = poll.target_names.map(n => 
            `<button onclick="setMe('${n}')" style="background:#222; margin-bottom:10px; border:1px solid #333;">${n}</button>`).join('');
    }
    function setMe(n) { localStorage.setItem('elite_user', n); location.reload(); }

    async function loadPoll(poll) {
        currentPoll = poll;
        document.getElementById('poll-view').classList.remove('hidden');
        document.getElementById('poll-display-title').innerText = poll.title;
        document.getElementById('id-name').innerText = `ç›®å‰èº«ä»½ï¼š${myName}`;
        document.getElementById('mode-label').innerText = poll.poll_type == 1 ? "ğŸ”¥ ç«¶æŠ€æ¨¡å¼" : "ğŸ—³ï¸ æŠ•ç¥¨æ¨¡å¼";
        if (isAdmin) document.getElementById('admin-controls').classList.remove('hidden');

        // æª¢æŸ¥æ˜¯å¦å·²æŠ•éç¥¨ (è®€å–è³‡æ–™åº«)
        const { data: v } = await _supabase.from('votes').select('option_id').eq('poll_id', poll.id).eq('voter_name', myName).maybeSingle();
        if (v) localVotedId = v.option_id;

        // Presence åŒæ­¥
        syncChannel = _supabase.channel('room_' + poll.id, { config: { presence: { key: myName } } });
        syncChannel.on('presence', { event: 'sync' }, () => {
            const state = syncChannel.presenceState();
            const readyNames = Object.keys(state).filter(k => state[k][0]?.ready);
            document.getElementById('ready-list').innerHTML = poll.target_names.map(n => 
                `<span class="user-chip ${readyNames.includes(n)?'ready':''}">${n}</span>`).join('');
            if (isAdmin) document.getElementById('start-btn').disabled = (readyNames.length < poll.target_voters);
        }).on('broadcast', { event: 'go' }, () => startUIFlow()).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await syncChannel.track({ ready: false });
        });

        // è³‡æ–™åº«å³æ™‚ç›£è½ (Realtime)
        _supabase.channel('db_sync').on('postgres_changes', { event: '*', schema: 'public', table: 'votes', filter: `poll_id=eq.${poll.id}` }, () => updateUI())
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'polls', filter: `id=eq.${poll.id}` }, (payload) => {
            if (payload.new.start_at && !isGameRunning) startUIFlow();
        }).on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'polls' }, () => location.reload()).subscribe();

        if (poll.start_at) startUIFlow(true);
        updateUI();
    }

    async function toggleReady() {
        const btn = document.getElementById('ready-btn');
        const isR = !btn.classList.contains('active');
        btn.classList.toggle('active');
        btn.style.background = isR ? "#444" : "var(--theme)";
        btn.innerText = isR ? "âœ“ å·²å°±ç·’" : "READY é»æˆ‘æº–å‚™";
        await syncChannel.track({ ready: isR });
    }

    async function broadcastStart() {
        const end = new Date(Date.now() + (currentPoll.duration_sec + 4) * 1000).toISOString();
        await _supabase.from('polls').update({ start_at: new Date().toISOString(), end_at: end }).eq('id', currentPoll.id);
        syncChannel.send({ type: 'broadcast', event: 'go', payload: {} });
    }

    function startUIFlow(isResume = false) {
        isGameRunning = true;
        document.getElementById('ready-zone').classList.add('hidden');
        if (isResume) {
            runGameLogic();
        } else {
            const overlay = document.getElementById('sync-overlay'), num = document.getElementById('countdown-num');
            overlay.style.display = 'flex';
            let c = 3;
            const t = setInterval(() => {
                num.innerText = c > 0 ? c : 'GO!';
                if (c < 0) { clearInterval(t); overlay.style.display = 'none'; runGameLogic(); }
                c--;
            }, 1000);
        }
    }

    function runGameLogic() {
        if (currentPoll.poll_type == 0) {
            document.getElementById('timer-box').innerText = "é€²è¡Œä¸­...";
        } else {
            const iv = setInterval(() => {
                const d = (new Date(currentPoll.end_at) - Date.now()) / 1000;
                if (d <= 0) { clearInterval(iv); finishGame(); }
                else document.getElementById('timer-box').innerText = d.toFixed(1) + "s";
            }, 50);
        }
    }

    async function castVote(id) {
        if (!isGameRunning) return;
        if (currentPoll.poll_type == 0 && localVotedId) return;

        // æœ¬åœ°ç«‹å³åé¥‹ï¼šæ”¹é¡è‰²ã€é–å®šé»æ“Š
        if (currentPoll.poll_type == 0) {
            localVotedId = id;
            updateUI(); 
        }

        const { error } = await _supabase.from('votes').insert([{ 
            poll_id: currentPoll.id, option_id: id, voter_name: myName 
        }]);

        if (error) {
            console.error("æŠ•ç¥¨å¤±æ•—", error.message);
            localVotedId = null; // å¤±æ•—æ™‚è§£é–
            updateUI();
        }
    }

    async function updateUI() {
        const { data: v } = await _supabase.from('votes').select('option_id, voter_name').eq('poll_id', currentPoll.id);
        const votes = v || [];
        const stats = {}; votes.forEach(x => stats[x.option_id] = (stats[x.option_id] || 0) + 1);
        
        // æ›´æ–°çµ±è¨ˆæ–‡å­—
        document.getElementById('voter-stats').innerText = `é€²åº¦: ${votes.length}/${currentPoll.target_voters}`;
        
        const cont = document.getElementById('poll-options');
        cont.innerHTML = '';
        Object.entries(currentPoll.options).forEach(([id, text]) => {
            const count = stats[id] || 0;
            const max = Math.max(...Object.values(stats), 1);
            const per = currentPoll.poll_type == 1 ? (count / max) * 100 : (count / currentPoll.target_voters) * 100;
            
            const isVoted = localVotedId == id;
            const div = document.createElement('div');
            div.className = `option-box ${isVoted ? 'voted' : ''}`;
            div.onclick = () => castVote(id);
            div.innerHTML = `
                <div class="progress-fill" style="width:${per}%"></div>
                <div class="content">
                    <div>
                        <div>${text}</div>
                        <div class="voted-mark">â— æ‚¨å·²é¸æ“‡æ­¤é …</div>
                    </div>
                    <div style="font-size:1.5rem; color:var(--theme)">${count}</div>
                </div>`;
            cont.appendChild(div);
        });

        // æŠ•ç¥¨æ¨¡å¼æª¢æŸ¥çµæŸ
        if (currentPoll.poll_type == 0 && votes.length >= currentPoll.target_voters && isGameRunning) {
            finishGame();
        }
    }

    function finishGame() {
        isGameRunning = false;
        document.getElementById('timer-box').innerText = "çµ æŸ";
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }

    async function resetSystem() { 
        if(confirm("ç¢ºå®šçµæŸæ­¤æˆ¿é–“ä¸¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
            await _supabase.from('polls').delete().eq('id', currentPoll.id);
            location.reload();
        }
    }
    init();
</script>
</body>
</html>

